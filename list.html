<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Wishlist</title>

  <!-- SEO -->
  <meta name="description" content="Your wishlist â€” add items and share with friends.">
  <meta property="og:title" content="My Wishlist">
  <meta property="og:description" content="Add items and share your wishlist with friends and family.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1 id="wishlistTitle">My Wishlist</h1>

  <nav>
    <button id="backBtn">Back</button>
    <button id="homeBtn">Home</button>
  </nav>

  <section id="myListPage">
    <!-- Title edit (owner only) -->
    <div id="titleEditRow" class="input-container" style="display:none;">
      <input type="text" id="titleEditInput" placeholder="Wishlist Name" maxlength="80">
      <button id="titleSaveBtn">Save Title</button>
    </div>

    <!-- Add row (owner only) -->
    <div id="addRow" class="input-container">
      <input type="text" id="itemName" placeholder="Item name">
      <input type="text" id="itemURL" placeholder="Amazon URL">
      <button id="addItemBtn">Add Item</button>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div>
      <div>Loading your wishlist...</div>
    </div>

    <ul id="wishlistContainer"></ul>
    <p id="emptyMessage" style="display:none;">This wishlist is empty. Add something above!</p>

    <button id="shareList">Share Wishlist</button>
    <p id="shareMessage"></p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiawooDcVM2qkvP10BuRVDoxIqEXz15ac",
      authDomain: "wishlistsite-c97bd.firebaseapp.com",
      projectId: "wishlistsite-c97bd",
      storageBucket: "wishlistsite-c97bd.firebasestorage.app",
      messagingSenderId: "525857492319",
      appId: "1:525857492319:web:25f40775bbe54312533aea",
      measurementId: "G-YHB16ZT4ED"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const titleEl = document.getElementById("wishlistTitle");
    const titleEditRow = document.getElementById("titleEditRow");
    const titleEditInput = document.getElementById("titleEditInput");
    const titleSaveBtn = document.getElementById("titleSaveBtn");

    const addRow = document.getElementById("addRow");
    const addBtn = document.getElementById("addItemBtn");
    const nameInput = document.getElementById("itemName");
    const urlInput = document.getElementById("itemURL");
    const listContainer = document.getElementById("wishlistContainer");
    const emptyMsg = document.getElementById("emptyMessage");
    const shareBtn = document.getElementById("shareList");
    const loadingState = document.getElementById("loadingState");

    let wishlistItems = [];
    let activeCode = null;
    let ownerMode = false;
    let listTitle = "My Wishlist";

    backBtn.addEventListener("click", () => history.back());
    homeBtn.addEventListener("click", () => {
      try { sessionStorage.setItem('cameFromInternal','1'); } catch(e){}
      window.location.href = "home.html";
    });

    function showToast(message, isError = false) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.style.backgroundColor = isError ? "#e74c3c" : "#28a745";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function getASIN(url) {
      const match = url.match(/\/([A-Z0-9]{10})(?:[/?]|$)/i);
      return match ? match[1] : null;
    }

    function getAmazonImageURL(url) {
      const asin = getASIN(url);
      if (!asin) return "https://via.placeholder.com/100";
      return `https://images-na.ssl-images-amazon.com/images/P/${asin}.jpg`;
    }

    function applyTitle() {
      titleEl.textContent = listTitle || "Wishlist";
      if (ownerMode) {
        titleEl.style.cursor = "pointer";
        titleEl.title = "Click to edit title";
        titleEl.onclick = () => {
          titleEditRow.style.display = "flex";
          titleEditInput.value = listTitle;
          titleEditInput.focus();
        };
      } else {
        titleEl.onclick = null;
        titleEl.style.cursor = "default";
      }
    }

    async function saveDoc(update) {
      await setDoc(doc(db, "wishlists", activeCode), update, { merge: true });
    }

    async function saveOwnerChanges() {
      if (!activeCode) return;
      try {
        await saveDoc({
          wishlist: wishlistItems,
          updated: new Date().toISOString()
        });
      } catch (e) {
        console.error(e);
        showToast("Failed to save changes.", true);
      }
    }

    function renderWishlist(readOnly = false) {
      listContainer.innerHTML = "";
      emptyMsg.style.display = wishlistItems.length === 0 ? "block" : "none";

      wishlistItems.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = "wishlist-item";
        if (item.purchased) li.classList.add("purchased");

        const infoDiv = document.createElement("div");
        infoDiv.className = "item-info";

        const img = document.createElement("img");
        img.src = item.image;
        img.alt = item.name;
        img.className = "product-image";
        img.onerror = () => { img.src = "https://via.placeholder.com/100"; };
        infoDiv.appendChild(img);

        const link = document.createElement("a");
        link.href = item.url;
        link.target = "_blank";
        link.textContent = item.name;
        infoDiv.appendChild(link);

        li.appendChild(infoDiv);

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "button-group";

        if (readOnly) {
          const buyBtn = document.createElement("a");
          buyBtn.textContent = "Buy Now";
          buyBtn.href = item.url;
          buyBtn.target = "_blank";
          buyBtn.className = "buy-now-btn";
          buttonsDiv.appendChild(buyBtn);

          const purchasedBtn = document.createElement("button");

          // ðŸ”» NEW: default text shows "Purchased!" when purchased; on hover shows "Undo"
          if (item.purchased) {
            purchasedBtn.textContent = "Purchased!";
            purchasedBtn.className = "remove-btn"; // gray by default, red on hover (your CSS)
            purchasedBtn.addEventListener("mouseenter", () => {
              // only swap label if still purchased
              if (wishlistItems[index]?.purchased) purchasedBtn.textContent = "Undo";
            });
            purchasedBtn.addEventListener("mouseleave", () => {
              if (wishlistItems[index]?.purchased) purchasedBtn.textContent = "Purchased!";
            });
          } else {
            purchasedBtn.textContent = "I've purchased";
            purchasedBtn.className = "purchased-btn";
          }

          purchasedBtn.onclick = async () => {
            wishlistItems[index].purchased = !wishlistItems[index].purchased;
            renderWishlist(true); // rebuild button/labels/hover handlers
            try {
              await saveOwnerChanges(); // persist so everyone sees the change
              showToast(wishlistItems[index].purchased ? "Marked as purchased." : "Marked as not purchased.");
            } catch (e) {
              showToast("Failed to update purchase state.", true);
            }
          };
          buttonsDiv.appendChild(purchasedBtn);
        } else {
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.className = "edit-btn";
          editBtn.onclick = () => enterEditMode(li, index);
          buttonsDiv.appendChild(editBtn);

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.className = "remove-btn";
          removeBtn.onclick = () => {
            li.classList.add("removing");
            setTimeout(async () => {
              wishlistItems.splice(index, 1);
              renderWishlist(false);
              await saveOwnerChanges();
            }, 150);
          };
          buttonsDiv.appendChild(removeBtn);
        }

        li.appendChild(buttonsDiv);
        listContainer.appendChild(li);
      });
    }

    function enterEditMode(li, index) {
      const item = wishlistItems[index];
      const infoDiv = li.querySelector(".item-info");
      const buttonsDiv = li.querySelector(".button-group");

      infoDiv.innerHTML = "";
      const img = document.createElement("img");
      img.src = item.image;
      img.alt = item.name;
      img.className = "product-image";
      img.onerror = () => { img.src = "https://via.placeholder.com/100"; };

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = item.name;
      nameInput.style.flex = "1 1 auto";
      nameInput.style.padding = "8px";
      nameInput.style.border = "1px solid #ccc";
      nameInput.style.borderRadius = "6px";

      const urlInput = document.createElement("input");
      urlInput.type = "text";
      urlInput.value = item.url;
      urlInput.style.flex = "1 1 auto";
      urlInput.style.padding = "8px";
      urlInput.style.border = "1px solid #ccc";
      urlInput.style.borderRadius = "6px";

      const editStack = document.createElement("div");
      editStack.style.display = "flex";
      editStack.style.flexDirection = "column";
      editStack.style.gap = "8px";
      editStack.style.flex = "1 1 auto";

      editStack.appendChild(nameInput);
      editStack.appendChild(urlInput);

      infoDiv.appendChild(img);
      infoDiv.appendChild(editStack);

      buttonsDiv.innerHTML = "";
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.className = "purchased-btn";
      saveBtn.onclick = async () => {
        const newName = nameInput.value.trim() || "Unknown Product";
        const newURL = urlInput.value.trim();
        if (!newURL) { showToast("URL cannot be empty.", true); return; }
        wishlistItems[index] = {
          name: newName,
          url: newURL,
          image: getAmazonImageURL(newURL),
          purchased: !!item.purchased
        };
        renderWishlist(false);
        await saveOwnerChanges();
      };

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "Cancel";
      cancelBtn.className = "remove-btn";
      cancelBtn.onclick = () => renderWishlist(false);

      buttonsDiv.appendChild(saveBtn);
      buttonsDiv.appendChild(cancelBtn);
    }

    addBtn.addEventListener("click", async () => {
      let name = nameInput.value.trim();
      const url = urlInput.value.trim();
      if (!url) { showToast("Please enter a valid Amazon URL.", true); return; }
      const imageUrl = getAmazonImageURL(url);
      if (!name) name = "Unknown Product";
      wishlistItems.push({ name, url, image: imageUrl, purchased: false });
      renderWishlist(false);
      nameInput.value = "";
      urlInput.value = "";
      await saveOwnerChanges(); // autosave so shared link has ALL items
    });

    titleSaveBtn.addEventListener("click", async () => {
      const newTitle = titleEditInput.value.trim() || "Wishlist";
      listTitle = newTitle;
      applyTitle();
      titleEditRow.style.display = "none";
      try {
        await saveDoc({ title: listTitle, updated: new Date().toISOString() });
        showToast("Title updated!");
      } catch (e) {
        console.error(e);
        showToast("Failed to update title.", true);
      }
    });

    shareBtn.addEventListener("click", async () => {
      if (!activeCode) return;
      try {
        // Save first to guarantee latest data is in Firestore
        await saveDoc({
          title: listTitle,
          wishlist: wishlistItems,
          updated: new Date().toISOString()
        });
        const shareUrl = `${window.location.origin}/list.html?code=${encodeURIComponent(activeCode)}`;
        await navigator.clipboard.writeText(shareUrl);
        showToast("Link copied!");
      } catch (e) {
        console.error(e);
        showToast("Could not copy link.", true);
      }
    });

    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const codeParam = params.get("code");
      const pinParam = params.get("pin");
      if (!codeParam) return;

      activeCode = codeParam;
      loadingState.style.display = "flex";

      try {
        const initialSnap = await getDoc(doc(db, "wishlists", activeCode));
        if (!initialSnap.exists()) {
          showToast("List not found.", true);
          loadingState.style.display = "none";
          return;
        }
        const initialData = initialSnap.data();
        ownerMode = !!(pinParam && initialData.pin === pinParam);

        addRow.style.display = ownerMode ? "flex" : "none";
        titleEditRow.style.display = "none";
        if (!ownerMode) shareBtn.style.display = "none";

        const ref = doc(db, "wishlists", activeCode);
        onSnapshot(ref, (snap) => {
          if (!snap.exists()) {
            showToast("List not found.", true);
            loadingState.style.display = "none";
            return;
          }
          const data = snap.data();
          listTitle = data.title || "Wishlist";
          wishlistItems = Array.isArray(data.wishlist) ? data.wishlist.map(it => ({
            name: it.name,
            url: it.url,
            image: it.image || getAmazonImageURL(it.url || ""),
            purchased: !!it.purchased
          })) : [];

          applyTitle();
          renderWishlist(!ownerMode);
          loadingState.style.display = "none";
        }, (err) => {
          console.error(err);
          showToast("Failed to keep list in sync.", true);
          loadingState.style.display = "none";
        });
      } catch (e) {
        console.error(e);
        showToast("Failed to load list.", true);
        loadingState.style.display = "none";
      }
    });
  </script>
</body>
</html>