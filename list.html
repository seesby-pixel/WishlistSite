<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Wishlist</title>
  <script async src="https://z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>

  <!-- SEO -->
  <meta name="description" content="Your wishlist ‚Äî add items and share with friends.">
  <meta property="og:title" content="My Wishlist">
  <meta property="og:description" content="Add items and share your wishlist with friends and family.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">

</style>


  <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- üé® Theme decorations placeholder -->
    <div id="theme-decorations"></div>
  <h1 id="wishlistTitle">My Wishlist</h1>

  <nav>
    <button id="backBtn">Back</button>
    <button id="homeBtn">Home</button>
  </nav>

  <section id="myListPage">
    <!-- NEW: Theme selector (owner only) -->
    <div id="themeRow" class="input-container" style="display:none;">
      <label for="themeSelect" style="align-self:center;">Theme:</label>
      <select id="themeSelect">
        <option value="default">Default Theme</option>
        <option value="christmas">Christmas üéÑ</option>
        <option value="elegant">Elegant üíç</option>
        <option value="pastel">Pastel üå∏</option>
        <option value="babyshower">Baby Shower üçº</option>
      </select>
    </div>

    <!-- Title edit (owner only) -->
    <div id="titleEditRow" class="input-container" style="display:none;">
      <input type="text" id="titleEditInput" placeholder="Wishlist Name" maxlength="80">
      <button id="titleSaveBtn">Save Title</button>
    </div>

    <!-- Add row (owner only) -->
    <div id="addRow" class="input-container">
      <input type="text" id="itemName" placeholder="Item name">
      <input type="text" id="itemURL" placeholder="Amazon URL">
      <button id="addItemBtn">Add Item</button>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div>
      <div>Loading your wishlist...</div>
    </div>

    <ul id="wishlistContainer"></ul>
    <p id="emptyMessage" style="display:none;">This wishlist is empty. Add something above!</p>

    <button id="shareList">Share Wishlist</button>
    <p id="shareMessage"></p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiawooDcVM2qkvP10BuRVDoxIqEXz15ac",
      authDomain: "wishlistsite-c97bd.firebaseapp.com",
      projectId: "wishlistsite-c97bd",
      storageBucket: "wishlistsite-c97bd.firebasestorage.app",
      messagingSenderId: "525857492319",
      appId: "1:525857492319:web:25f40775bbe54312533aea",
      measurementId: "G-YHB16ZT4ED"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const titleEl = document.getElementById("wishlistTitle");
    const titleEditRow = document.getElementById("titleEditRow");
    const titleEditInput = document.getElementById("titleEditInput");
    const titleSaveBtn = document.getElementById("titleSaveBtn");

    const addRow = document.getElementById("addRow");
    const addBtn = document.getElementById("addItemBtn");
    const nameInput = document.getElementById("itemName");
    const urlInput = document.getElementById("itemURL");
    const listContainer = document.getElementById("wishlistContainer");
    const emptyMsg = document.getElementById("emptyMessage");
    const shareBtn = document.getElementById("shareList");
    const loadingState = document.getElementById("loadingState");

    // NEW: theme controls
    const themeRow = document.getElementById("themeRow");
    const themeSelect = document.getElementById("themeSelect");

    let wishlistItems = [];
    let activeCode = null;
    let ownerMode = false;
    let listTitle = "My Wishlist";
    let activeTheme = "default";

    backBtn.addEventListener("click", () => history.back());
    homeBtn.addEventListener("click", () => {
      try { sessionStorage.setItem('cameFromInternal','1'); } catch(e){}
      window.location.href = "/home";
    });

    function showToast(message, isError = false) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.style.backgroundColor = isError ? "#e74c3c" : "#28a745";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ‚úÖ Fast ASIN image builder
    function extractASIN(url) {
      const match = url.match(/\/([A-Z0-9]{10})(?:[/?]|$)/i);
      return match ? match[1] : null;
    }

    function buildAmazonImageURL(url) {
      const asin = extractASIN(url);
      return asin
        ? `https://images-na.ssl-images-amazon.com/images/P/${asin}.jpg`
        : "https://via.placeholder.com/100";
    }

    // ‚úÖ Background fallback to upgrade images for tricky long URLs (non-blocking)
    async function fetchAmazonImageFallback(url) {
      try {
        const asin = extractASIN(url);
        const normalized = asin ? `https://www.amazon.ca/dp/${asin}` : url;
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(normalized)}`;
        const resp = await fetch(proxyUrl);
        const data = await resp.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");

        // Try common <img> spots
        const imgEl = doc.querySelector("#imgTagWrapperId img, #landingImage, img[data-old-hires]");
        let src = imgEl ? (imgEl.getAttribute("src") || imgEl.getAttribute("data-old-hires") || "") : "";

        // data-a-dynamic-image JSON
        if (!src) {
          const landing = doc.querySelector("#landingImage");
          const daiRaw = landing?.getAttribute("data-a-dynamic-image");
          if (daiRaw) {
            try {
              const daiJson = JSON.parse(daiRaw.replace(/&quot;/g, '"'));
              const keys = Object.keys(daiJson || {});
              if (keys.length) src = keys[0];
            } catch {}
          }
        }

        // Inline hiRes/large image references
        if (!src) {
          const hiRes = data.contents.match(/"hiRes"\s*:\s*"(https:\/\/m\.media-amazon\.com\/images\/I\/[^"]+?\.jpg[^"]*)"/);
          if (hiRes && hiRes[1]) src = hiRes[1];
        }
        if (!src) {
          const large = data.contents.match(/"large"\s*:\s*"(https:\/\/m\.media-amazon\.com\/images\/I\/[^"]+?\.jpg[^"]*)"/);
          if (large && large[1]) src = large[1];
        }

        // Any CDN jpg
        if (!src) {
          const anyCdn = data.contents.match(/https:\/\/m\.media-amazon\.com\/images\/I\/[A-Za-z0-9._%\-]+\.jpg[^"')]*/);
          if (anyCdn && anyCdn[0]) src = anyCdn[0];
        }

        return src || "";
      } catch {
        return "";
      }
    }

    async function backgroundEnhanceAmazonImage(url, index) {
      const better = await fetchAmazonImageFallback(url);
      if (!better) return;
      if (!wishlistItems[index]) return;
      if (wishlistItems[index].image === better) return;
      wishlistItems[index].image = better;
      renderWishlist(false);
      try { await saveOwnerChanges(); } catch {}
    }

    function applyTitle() {
      titleEl.textContent = listTitle || "Wishlist";
      if (ownerMode) {
        titleEl.style.cursor = "pointer";
        titleEl.title = "Click to edit title";
        titleEl.onclick = () => {
          titleEditRow.style.display = "flex";
          titleEditInput.value = listTitle;
          titleEditInput.focus();
        };
      } else {
        titleEl.onclick = null;
        titleEl.style.cursor = "default";
      }
    }

    async function saveDoc(update) {
      await setDoc(doc(db, "wishlists", activeCode), update, { merge: true });
    }

    async function saveOwnerChanges() {
      if (!activeCode) return;
      try {
        await saveDoc({
          wishlist: wishlistItems,
          updated: new Date().toISOString()
        });
      } catch (e) {
        console.error(e);
        showToast("Failed to save changes.", true);
      }
    }

    function renderWishlist(readOnly = false) {
      listContainer.innerHTML = "";
      emptyMsg.style.display = wishlistItems.length === 0 ? "block" : "none";

      wishlistItems.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = "wishlist-item";

        if (item.purchased && readOnly) li.classList.add("purchased");

        const infoDiv = document.createElement("div");
        infoDiv.className = "item-info";

        const img = document.createElement("img");
        img.src = item.image;
        img.alt = item.name;
        img.className = "product-image";
        img.loading = "lazy"; // ‚úÖ lazy-load for speed
        img.onerror = () => { img.src = "https://via.placeholder.com/100"; };
        infoDiv.appendChild(img);

        const link = document.createElement("a");
        link.href = item.url;
        link.target = "_blank";
        link.textContent = item.name;
        infoDiv.appendChild(link);

        li.appendChild(infoDiv);

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "button-group";

        if (readOnly) {
          const buyBtn = document.createElement("a");
          buyBtn.textContent = "Buy Now";
          buyBtn.href = item.url;
          buyBtn.target = "_blank";
          buyBtn.className = "buy-now-btn";
          buttonsDiv.appendChild(buyBtn);

          const purchasedBtn = document.createElement("button");
          if (item.purchased) {
            purchasedBtn.textContent = "Purchased!";
            purchasedBtn.className = "remove-btn";
            purchasedBtn.addEventListener("mouseenter", () => {
              if (wishlistItems[index]?.purchased) purchasedBtn.textContent = "Undo";
            });
            purchasedBtn.addEventListener("mouseleave", () => {
              if (wishlistItems[index]?.purchased) purchasedBtn.textContent = "Purchased!";
            });
          } else {
            purchasedBtn.textContent = "I've purchased";
            purchasedBtn.className = "purchased-btn";
          }
          purchasedBtn.onclick = async () => {
            wishlistItems[index].purchased = !wishlistItems[index].purchased;
            renderWishlist(true);
            try {
              await saveOwnerChanges();
              showToast(wishlistItems[index].purchased ? "Marked as purchased." : "Marked as not purchased.");
            } catch (e) {
              showToast("Failed to update purchase state.", true);
            }
          };
          buttonsDiv.appendChild(purchasedBtn);
        } else {
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.className = "edit-btn";
          editBtn.onclick = () => enterEditMode(li, index);
          buttonsDiv.appendChild(editBtn);

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.className = "remove-btn";
          removeBtn.onclick = () => {
            li.classList.add("removing");
            setTimeout(async () => {
              wishlistItems.splice(index, 1);
              renderWishlist(false);
              await saveOwnerChanges();
            }, 150);
          };
          buttonsDiv.appendChild(removeBtn);
        }

        li.appendChild(buttonsDiv);
        listContainer.appendChild(li);
      });
    }

    function enterEditMode(li, index) {
      const item = wishlistItems[index];
      const infoDiv = li.querySelector(".item-info");
      const buttonsDiv = li.querySelector(".button-group");

      infoDiv.innerHTML = "";
      const img = document.createElement("img");
      img.src = item.image;
      img.alt = item.name;
      img.className = "product-image";
      img.onerror = () => { img.src = "https://via.placeholder.com/100"; };

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = item.name;
      nameInput.style.flex = "1 1 auto";
      nameInput.style.padding = "8px";
      nameInput.style.border = "1px solid #ccc";
      nameInput.style.borderRadius = "6px";

      const urlInput = document.createElement("input");
      urlInput.type = "text";
      urlInput.value = item.url;
      urlInput.style.flex = "1 1 auto";
      urlInput.style.padding = "8px";
      urlInput.style.border = "1px solid #ccc";
      urlInput.style.borderRadius = "6px";

      const editStack = document.createElement("div");
      editStack.style.display = "flex";
      editStack.style.flexDirection = "column";
      editStack.style.gap = "8px";
      editStack.style.flex = "1 1 auto";

      editStack.appendChild(nameInput);
      editStack.appendChild(urlInput);

      infoDiv.appendChild(img);
      infoDiv.appendChild(editStack);

      buttonsDiv.innerHTML = "";
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.className = "purchased-btn";
      saveBtn.onclick = async () => {
        const newName = nameInput.value.trim() || "Unknown Product";
        const newURL = urlInput.value.trim();
        if (!newURL) { showToast("URL cannot be empty.", true); return; }
        wishlistItems[index] = {
          name: newName,
          url: newURL,
          image: buildAmazonImageURL(newURL),
          purchased: !!item.purchased
        };
        renderWishlist(false);
        await saveOwnerChanges();
        // ‚úÖ Upgrade image in background
        backgroundEnhanceAmazonImage(newURL, index);
      };

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "Cancel";
      cancelBtn.className = "remove-btn";
      cancelBtn.onclick = () => renderWishlist(false);

      buttonsDiv.appendChild(saveBtn);
      buttonsDiv.appendChild(cancelBtn);
    }

    addBtn.addEventListener("click", async () => {
      let name = nameInput.value.trim();
    let url = urlInput.value.trim();
if (!url) { showToast("Please enter a valid Amazon URL.", true); return; }

// Clean + attach affiliate tag before saving (uses script.js‚Äôs function)
try {
  url = await window.processAmazonLink(url);
} catch (e) {
  showToast(e.message || "Invalid Amazon URL.", true);
  return;
}

const imageUrl = buildAmazonImageURL(url); // instant
if (!name) name = "Unknown Product";

      wishlistItems.push({ name, url, image: imageUrl, purchased: false });
      renderWishlist(false);
      // ‚úÖ Upgrade image in background without blocking UX
      backgroundEnhanceAmazonImage(url, wishlistItems.length - 1);
      nameInput.value = "";
      urlInput.value = "";
      await saveOwnerChanges(); // keep your autosave behavior
    });

    titleSaveBtn.addEventListener("click", async () => {
      const newTitle = titleEditInput.value.trim() || "Wishlist";
      listTitle = newTitle;
      applyTitle();
      titleEditRow.style.display = "none";
      try {
        await saveDoc({ title: listTitle, updated: new Date().toISOString() });
        showToast("Title updated!");
      } catch (e) {
        console.error(e);
        showToast("Failed to update title.", true);
      }
    });

    shareBtn.addEventListener("click", async () => {
  if (!activeCode) {
    if (typeof showToast === "function") showToast("No list code to share.", true);
    return;
  }

  // Build URL that works under subfolders too
  const base = location.pathname.replace(/[^/]+$/, "");
  const shareUrl = `${location.origin}${base}/list?code=${encodeURIComponent(activeCode)}`;

  let copied = false;
  try {
    await navigator.clipboard.writeText(shareUrl);
    copied = true;
  } catch {
    try {
      const ta = document.createElement("textarea");
      ta.value = shareUrl;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.opacity = "0";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      copied = true;
    } catch {}
  }
  if (typeof showToast === "function") showToast(copied ? "Link copied!" : "Could not copy link", !copied);

  try {
    await saveDoc({
      title: listTitle,
      wishlist: wishlistItems,
      updated: new Date().toISOString(),
    });
  } catch (e) {
    console.error(e);
  }
});


    // THEME: apply/remove body class
    function applyTheme(theme) {
      document.body.classList.remove("theme-christmas","theme-elegant","theme-pastel","theme-babyshower");
      if (theme && theme !== "default") document.body.classList.add(`theme-${theme}`);
    }

    themeSelect?.addEventListener("change", async () => {
      const newTheme = themeSelect.value;
      applyTheme(newTheme);
      try {
        await saveDoc({ theme: newTheme, updated: new Date().toISOString() });
        showToast("Theme updated!");
      } catch (e) {
        console.error(e);
        showToast("Failed to update theme.", true);
      }
    });

    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const codeParam = params.get("code");
      if (!codeParam) return;

      // Case-insensitive code
      activeCode = (codeParam || "").toLowerCase();
      loadingState.style.display = "flex";

      try {
        const initialSnap = await getDoc(doc(db, "wishlists", activeCode));
        if (!initialSnap.exists()) {
          showToast("List not found.", true);
          loadingState.style.display = "none";
          return;
        }
        const initialData = initialSnap.data();

        // ‚úÖ Authoritative, permanent rule:
        // Owner ONLY if sessionStorage.currentOwner.code matches this code.
        let currentOwner = null;
        try { currentOwner = JSON.parse(sessionStorage.getItem('currentOwner') || 'null'); } catch(e){ currentOwner = null; }
        ownerMode = !!(currentOwner && currentOwner.code && currentOwner.code === activeCode);

        // UI based on owner mode
        addRow.style.display = ownerMode ? "flex" : "none";
        titleEditRow.style.display = "none";
        themeRow.style.display = ownerMode ? "flex" : "none";
        if (!ownerMode) shareBtn.style.display = "none";

        // Optional: Logout (clears only this-session ownership)
        if (ownerMode && !document.querySelector(".logout-btn")) {
  const logoutBtn = document.createElement("button");
  logoutBtn.textContent = "Logout";
  logoutBtn.className = "logout-btn";
  Object.assign(logoutBtn.style, {
    position: "fixed", top: "14px", right: "14px", zIndex: 1000,
    background: "#495057", color: "#fff", border: "none",
    padding: "8px 14px", borderRadius: "6px", cursor: "pointer",
    boxShadow: "0 2px 6px rgba(0,0,0,.15)"
  });
  logoutBtn.addEventListener("click", () => {
    const confirmLogout = confirm("Are you sure you want to log out?");
    if (confirmLogout) {
      sessionStorage.removeItem('currentOwner');
      window.location.href = "/home";
    }
  });
  document.body.appendChild(logoutBtn);
}

        // Live sync
        const ref = doc(db, "wishlists", activeCode);
        onSnapshot(ref, (snap) => {
          if (!snap.exists()) {
            showToast("List not found.", true);
            loadingState.style.display = "none";
            return;
          }
          const data = snap.data();
          listTitle = data.title || "Wishlist";
          const theme = data.theme || "default";
          activeTheme = theme;
          applyTheme(theme);
          if (themeSelect) themeSelect.value = theme;

          wishlistItems = Array.isArray(data.wishlist) ? data.wishlist.map(it => ({
            name: it.name,
            url: it.url,
            image: it.image || "https://via.placeholder.com/100",
            purchased: !!it.purchased
          })) : [];

          applyTitle();
          renderWishlist(!ownerMode);
          loadingState.style.display = "none";
        }, (err) => {
          console.error(err);
          showToast("Failed to keep list in sync.", true);
          loadingState.style.display = "none";
        });
      } catch (e) {
        console.error(e);
        showToast("Failed to load list.", true);
        loadingState.style.display = "none";
      }
    });
    
  </script>
  
<script type="module" src="script.js"></script>

</body>
</html>
